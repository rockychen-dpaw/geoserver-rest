import os
import re

styleid_re = re.compile("\\<id\\>(?P<id>StyleInfo[^\\<\\>]+)\\</id\\>",re.I)
workspaceid_re = re.compile("\\<id\\>(?P<id>Workspace[^\\<\\>]+)\\</id\\>",re.I)
namespaceid_re = re.compile("\\<id\\>(?P<id>Namespace[^\\<\\>]+)\\</id\\>",re.I)
datastoreid_re = re.compile("\\<id\\>(?P<id>DataStore[^\\<\\>]+)\\</id\\>",re.I)
wmsstoreid_re = re.compile("\\<id\\>(?P<id>WMSStore[^\\<\\>]+)\\</id\\>",re.I)
featuretypeid_re = re.compile("\\<id\\>(?P<id>FeatureType[^\\<\\>]+)\\</id\\>",re.I)
layerid_re = re.compile("\\<id\\>(?P<id>Layer[^\\<\\>]+)\\</id\\>",re.I)
wmslayerid_re = re.compile("\\<id\\>(?P<id>WMSLayer[^\\<\\>]+)\\</id\\>",re.I)
layergroupid_re = re.compile("\\<id\\>(?P<id>LayerGroup[^\\<\\>]+)\\</id\\>",re.I)
gwclayername_re = re.compile("\\<name\\>(?P<name>[^\\<\\>]+)\\</name\\>")
class GeoserverDataConsistencyCheck(object):
    styleids = {}
    styles = {}a

    workspaceids =  {}
    namespaceids = {}

    datastoreids = {}

    wmsstoreids = {}

    layerids = {}

    featuretypeids = {}
    featuretypes = {}a

    wmslayerids = {}
    wmslayers = {}

    layergroupids = {}
    layergroups = {}

    gwclayers = {}

    errors = []
    warrnings = []
    def __init__(self,geoserver_data_dir)
        self.geoserver_data_dir = geoserver_data_dir

    def _load_workspaces(self):
        for workspace in os.listdir(os.path.join(self.geoserver_data_dir,"workspaces")):
            if workspace == "styles":
                continue
            elif not os.path.isdir(os.path.join(self.geoserver_data_dir,"workspaces",workspace)):
                #not a workspace
                continue
            else:
                workspacepath = os.path.join(self.geoserver_data_dir,"workspaces",workspace)
                if not os.path.exists(os.path.join(workspacepath,"namespace.xml")) or not os.path.exists(os.path.join(workspacepath,"workspace.xml")):
                    #workspace is not enabled
                    print("The workspace '{}' is not enabled".format(workspace))
                    self.warrnings.append((workspace,"The workspace '{}' is not enabled".format(workspace)))
                    continue

                workspacefile = os.path.join(workspacepath,"workspace.xml")
                with open(workspacefile) as f:
                    data = f.read()
                m = workspaceid_re.search(data)
                if not m:
                    self.errors.append((workspace,"Invalid workspace '{}', can't find the workspace id".format(workspacefile)))
                    continue

                workspaceid = m.group("id")
                self.workspaceids[workspaceid] = (workspace,workspacefile)

                namespacefile = os.path.join(workspacepath,"namespace.xml")
                with open(namespacefile) as f:
                    data = f.read()
                m = namespaceid_re.search(data)
                if not m:
                    self.errors.append((workspace,"Invalid namespace '{}', can't find the workspace id".format(namespacefile)))
                    continue

                namespaceid = m.group("id")
                self.namespaceids[namespaceid] = (workspace,namespacefile)

        print("Load {} workspaces".format(len(self.workspaceids)))
        print("Load {} namespaces".format(len(self.namespaceids)))

    def _load_datastores(self):
        for workspace in os.listdir(os.path.join(self.geoserver_data_dir,"workspaces")):
            if workspace == "styles":
                continue
            elif not os.path.isdir(os.path.join(self.geoserver_data_dir,"workspaces",workspace)):
                #not a workspace
                continue
            else:
                workspacepath = os.path.join(self.geoserver_data_dir,"workspaces",workspace)
                if not os.path.exists(os.path.join(workspacepath,"namespace.xml")) or not os.path.exists(os.path.join(workspacepath,"workspace.xml")):
                    #workspace is not enabled
                    print("The workspace '{}' is not enabled".format(workspace))
                    self.warrnings.append((workspace,"The workspace '{}' is not enabled".format(workspace)))
                    continue

                for store in os.listdir(os.path.join(workspacepath)):
                    if not os.path.isdir(os.path.join(workspacepath,store)):
                        continue
                    storefile = os.path.join(workspacepath,store,"datastore.xml")
                    if not os.path.exists(storefile):
                        #has no datastore
                        continue
                    with open(storefile) as f:
                        data = f.read()
                    m = datastoreid_re.search(data)
                    if not m:
                        self.errors.append(("{}:{}".format(workspace,store),"Invalid datastore '{}', can't find the datastore id".format(storefile)))
                        continue
                    storeid = m.group("id")
                    self.datastoreids[storeid] = (workspace,store,storefile)

                    m = workspaceid_re.search(data)
                    if not m:
                        self.errors.append(("{}:{}".format(workspace,store),"Invalid datastore '{}', can't find the workspace id which the datastore belongs to.".format(storefile)))
                        continue
                    workspaceid = m.group("id")
                    if workspaceid not in self.workspaceids:
                        self.errors.append(("{}:{}".format(workspace,store),"Invalid datastore '{}', the workspace id '{}' doesn't exist.".format(storefile,workspaceid)))
                        continue

        print("Load {} datastores".format(len(self.datastoreids)))

    def _load_wmsstores(self):
        for workspace in os.listdir(os.path.join(self.geoserver_data_dir,"workspaces")):
            if workspace == "styles":
                continue
            elif not os.path.isdir(os.path.join(self.geoserver_data_dir,"workspaces",workspace)):
                #not a workspace
                continue
            else:
                workspacepath = os.path.join(self.geoserver_data_dir,"workspaces",workspace)
                if not os.path.exists(os.path.join(workspacepath,"namespace.xml")) or not os.path.exists(os.path.join(workspacepath,"workspace.xml")):
                    #workspace is not enabled
                    print("The workspace '{}' is not enabled".format(workspace))
                    self.warrnings.append((workspace,"The workspace '{}' is not enabled".format(workspace)))
                    continue

                for store in os.listdir(os.path.join(workspacepath)):
                    if not os.path.isdir(os.path.join(workspacepath,store)):
                        continue
                    storefile = os.path.join(workspacepath,store,"wmsstore.xml")
                    if not os.path.exists(storefile):
                        #has no wmsstore
                        continue
                    with open(storefile) as f:
                        data = f.read()
                    m = wmsstoreid_re.search(data)
                    if not m:
                        self.errors.append(("{}:{}".format(workspace,store),"Invalid wmsstore '{}', can't find the wmsstore id".format(storefile)))
                        continue

                    storeid = m.group("id")
                    self.wmsstoreids[storeid] = (workspace,store,storefile)

                    m = workspaceid_re.search(data)
                    if not m:
                        self.errors.append(("{}:{}".format(workspace,store),"Invalid wmsstore '{}', can't find the workspace id which the wmsstore belongs to.".format(storefile)))
                        continue

                    workspaceid = m.group("id")
                    if workspaceid not in self.workspaceids:
                        self.errors.append(("{}:{}".format(workspace,store),"Invalid wmsstore '{}', the workspace id '{}' doesn't exist.".format(storefile,workspaceid)))
                        continue

        print("Load {} wmsstores".format(len(self.wmsstoreids)))


    def _load_featuretypes(self):
        for workspace in os.listdir(os.path.join(self.geoserver_data_dir,"workspaces")):
            if workspace == "styles":
                continue
            elif not os.path.isdir(os.path.join(self.geoserver_data_dir,"workspaces",workspace)):
                #not a workspace
                continue
            else:
                workspacepath = os.path.join(self.geoserver_data_dir,"workspaces",workspace)
                if not os.path.exists(os.path.join(workspacepath,"namespace.xml")) or not os.path.exists(os.path.join(workspacepath,"workspace.xml")):
                    #workspace is not enabled
                    print("The workspace '{}' is not enabled".format(workspace))
                    self.warrnings.append((workspace,"The workspace '{}' is not enabled".format(workspace)))
                    continue

                self.featuretypes[workspace] = {}

                for store in os.listdir(os.path.join(workspacepath)):
                    if not os.path.isdir(os.path.join(workspacepath,store)):
                        continue
                    if not os.path.exists(os.path.join(workspacepath,store,"datastore.xml")):
                        #not a datastore
                        continue

                    self.featuretypes[workspace][store] = {}
                    storepath = os.path.join(workspacepath,store)
                    for featuretype in os.path.listdir(storepath):
                        if not os.path.isdir(os.path.join(storepath,featuretype)):
                            continue

                        featuretypefile = os.path.join(storepath,featuretype,"featuretype.xml")
                        if not os.path.exists(featuretypefile):
                            self.warnings.append("{}:{}:{}".format(workspace,store,featuretype),"Can't find the file '{3}', The featuretype({0}:{1}:{2}) is ignored".format(workspace,store,featuretype,featuretypefile))
                            continue

                        with open(featuretypefile) as f:
                            data = f.read()
                        m = featuretypeid_re.search(data)
                        if not m:
                            self.errors.append(("{}:{}:{}".format(workspace,store,featuretype),"Invalid featuretype '{}:{}:{}', can't find the featuretype id in file '{}'".format(workspace,store,featuretype,featuretypefile)))
                            continue
                        featuretypeid = m.group("id")
                        self.featuretypeids[featuretypeid] = (workspace,store,featuretype,featuretypefile)
                        self.featuretypes[workspace][store][featuretype] = (featuretypeid,featuretypefile)

                        m = namespaceid_re.search(data)
                        if not m:
                            self.errors.append(("{}:{}:{}".format(workspace,store,featuretype),"Invalid featuretype '{}:{}:{}', can't find the namespace id in file '{}'".format(workspace,store,featuretype,featuretypefile)))
                            continue

                        namespaceid = m.group("id")
                        if namespaceid not in self.namepaceids:
                            self.errors.append(("{}:{}:{}".format(workspace,store,featuretype),"Invalid featuretype '{0}:{1}:{2}', the namespace id({4}) in file '{3}' doesn't exist'".format(workspace,store,featuretype,featuretypefile,namespaceid)))
                            continue

                        m = datastoreid_re.search(data)
                        if not m:
                            self.errors.append(("{}:{}:{}".format(workspace,store,featuretype),"Invalid featuretype '{}:{}:{}', can't find the datastore id in file '{}'".format(workspace,store,featuretype,featuretypefile)))
                            continue

                        datastoreid = m.group("id")
                        if datastoreid not in self.datatoreids:
                            self.errors.append(("{}:{}:{}".format(workspace,store,featuretype),"Invalid featuretype '{0}:{1}:{2}', the datastore id({4}) in file '{3}' doesn't exist'".format(workspace,store,featuretype,featuretypefile,datastoreid)))
                            continue

                        layerfile = os.path.join(storepath,featuretype,"layer.xml")
                        if not os.path.exists(layerfile):
                            self.warnings.append("{}:{}:{}".format(workspace,store,featuretype),"Can't find the file '{3}', The featuretype({0}:{1}:{2}) is disabled".format(workspace,store,featuretype,layerfile))
                            continue

                        with open(layerfile) as f:
                            data = f.read()
                        m = layerid_re.search(data)
                        if not m:
                            self.errors.append(("{}:{}:{}".format(workspace,store,featuretype),"Invalid featuretype '{}:{}:{}', can't find the layer id in file '{}'".format(workspace,store,featuretype,layerfile)))
                            continue
                        layerid = m.group("id")
                        self.layerids[layerid] = (workspace,store,featuretype,layerfile)

                        m = featuretypeid_re.search(data)
                        if not m:
                            self.errors.append(("{}:{}:{}".format(workspace,store,featuretype),"Invalid featuretype '{}:{}:{}', can't find the featuretype id in file '{}'".format(workspace,store,featuretype,layerfile)))
                            continue

                        featuretypeid = m.group("id")
                        if featuretypeid not in self.featuretypeids:
                            self.errors.append(("{}:{}:{}".format(workspace,store,featuretype),"Invalid featuretype '{0}:{1}:{2}', the featuretype id({4}) in file '{3}' doesn't exist'".format(workspace,store,featuretype,layerfile,featuretypeid)))
                            continue
                        
                        start = 0
                        while True:
                            m = styleid_re.search(data,start)
                            if not m:
                                break
                            styleid = m.group("id")
                            if styleid not in self.styleids:
                                self.errors.append(("{}:{}:{}".format(workspace,store,featuretype),"Invalid featuretype '{0}:{1}:{2}', the style id({4}) in file '{3}' doesn't exist'".format(workspace,store,featuretype,layerfile,styleid)))
                            start = m.end()

                    if len(self.featuretypes[workspace][store]) > 0:
                        print("Load {2} featuretypes in datastore({0}:{1})".format(workspace,store,len(self.featuretypes[workspace][store])))

                count = 0
                for store,storedata in self.featuretypes[workspace].items():
                    count += len(storedata)
                if count > 0:
                    print("Load {1} featuretypes in workspace({0})".format(workspace,count))


        count = 0
        for workspace,workspaceata in self.featuretypes.items():
            for store,storedata in workspacedata.items():
                count += len(storedata)
        if count > 0:
            print("Load {} featuretypes".format(count))

    def _load_wmslayers(self):
        for workspace in os.listdir(os.path.join(self.geoserver_data_dir,"workspaces")):
            if workspace == "styles":
                continue
            elif not os.path.isdir(os.path.join(self.geoserver_data_dir,"workspaces",workspace)):
                #not a workspace
                continue
            else:
                workspacepath = os.path.join(self.geoserver_data_dir,"workspaces",workspace)
                if not os.path.exists(os.path.join(workspacepath,"namespace.xml")) or not os.path.exists(os.path.join(workspacepath,"workspace.xml")):
                    #workspace is not enabled
                    print("The workspace '{}' is not enabled".format(workspace))
                    continue

                self.wmslayers[workspace] = {}

                for store in os.listdir(os.path.join(workspacepath)):
                    if not os.path.isdir(os.path.join(workspacepath,store)):
                        continue
                    if not os.path.exists(os.path.join(workspacepath,store,"wmsstore.xml")):
                        #not a datastore
                        continue

                    self.wmslayers[workspace][store] = {}
                    storepath = os.path.join(workspacepath,store)
                    for wmslayer in os.path.listdir(storepath):
                        if not os.path.isdir(os.path.join(storepath,wmslayer)):
                            continue

                        wmslayerfile = os.path.join(storepath,featuretype,"wmslayer.xml")
                        if not os.path.exists(wmslayerfile):
                            self.warnings.append("{}:{}:{}".format(workspace,store,wmslayer),"Can't find the file '{3}', The wmslayer({0}:{1}:{2}) is ignored".format(workspace,store,wmslayer,wmslayerfile))
                            continue

                        with open(wmslayerfile) as f:
                            data = f.read()
                        m = wmslayerid_re.search(data)
                        if not m:
                            self.errors.append(("{}:{}:{}".format(workspace,store,wmslayer),"Invalid wmslayer '{}:{}:{}', can't find the wmslayer id in file '{}'".format(workspace,store,wmslayer,wmslayerfile)))
                            continue
                        wmslayerid = m.group("id")
                        self.wmslayerids[wmslayerid] = (workspace,store,wmslayer,wmslayerfile)
                        self.wmslayers[workspace][store][wmslayer] = (wmslayerid,wmslayerfile)

                        m = namespaceid_re.search(data)
                        if not m:
                            self.errors.append(("{}:{}:{}".format(workspace,store,wmslayer),"Invalid wmslayer '{}:{}:{}', can't find the namespace id in file '{}'".format(workspace,store,wmslayer,wmslayerfile)))
                            continue

                        namespaceid = m.group("id")
                        if namespaceid not in self.namepaceids:
                            self.errors.append(("{}:{}:{}".format(workspace,store,wmslayer),"Invalid wmslayer '{0}:{1}:{2}', the namespace id({4}) in file '{3}' doesn't exist'".format(workspace,store,wmslayer,wmslayerfile,namespaceid)))
                            continue

                        m = wmsstoreid_re.search(data)
                        if not m:
                            self.errors.append(("{}:{}:{}".format(workspace,store,wmslayer),"Invalid wmslayer '{}:{}:{}', can't find the wmsstore id in file '{}'".format(workspace,store,wmslayer,wmslayerfile)))
                            continue

                        wmsstoreid = m.group("id")
                        if wmsstoreid not in self.wmsstoreids:
                            self.errors.append(("{}:{}:{}".format(workspace,store,wmslayer),"Invalid wmslayer '{0}:{1}:{2}', the wmsstore id({4}) in file '{3}' doesn't exist'".format(workspace,store,wmslayer,wmslayerfile,wmsstoreid)))
                            continue

                        layerfile = os.path.join(storepath,wmslayer,"layer.xml")
                        if not os.path.exists(layerfile):
                            self.warnings.append("{}:{}:{}".format(workspace,store,wmslayer),"Can't find the file '{3}', The wmslayer({0}:{1}:{2}) is ignored".format(workspace,store,wmslayer,layerfile))
                            continue

                        m = layerid_re.search(data)
                        if not m:
                            self.errors.append(("{}:{}:{}".format(workspace,store,wmslayer),"Invalid wmslayer '{}:{}:{}', can't find the layer id in file '{}'".format(workspace,store,wmslayer,layerfile)))
                            continue
                        layerid = m.group("id")
                        self.layerids[layerid] = (workspace,store,wmslayer,layerfile)

                        m = wmslayerid_re.search(data)
                        if not m:
                            self.errors.append(("{}:{}:{}".format(workspace,store,wmslayer),"Invalid wmslayer '{}:{}:{}', can't find the wmslayer id in file '{}'".format(workspace,store,wmslayer,layerfile)))
                            continue

                        wmslayerid = m.group("id")
                        if wmslayerid not in self.wmslayerids:
                            self.errors.append(("{}:{}:{}".format(workspace,store,wmslayer),"Invalid wmslayer '{0}:{1}:{2}', the wmslayer id({4}) in file '{3}' doesn't exist'".format(workspace,store,featuretype,layerfile,wmslayerid)))
                            continue
                        
                    if len(self.wmslayers[workspace][store]) > 0:
                        print("Load {2} wmslayers in wmsstore({0}:{1})".format(workspace,store,len(self.wmslayers[workspace][store])))

                count = 0
                for store,storedata in self.wmslayers[workspace].items():
                    count += len(storedata)
                if count > 0:
                    print("Load {1} wmslayers in workspace({0})".format(workspace,count))


        count = 0
        for workspace,workspaceata in self.wmslayers.items():
            for store,storedata in workspacedata.items():
                count += len(storedata)
        if count > 0:
            print("Load {} wmslayers".format(count))


    def _load_layergroups(self):
        for workspace in os.listdir(os.path.join(self.geoserver_data_dir,"workspaces")):
            if workspace == "styles":
                continue
            elif not os.path.isdir(os.path.join(self.geoserver_data_dir,"workspaces",workspace)):
                #not a workspace
                continue
            else:
                workspacepath = os.path.join(self.geoserver_data_dir,"workspaces",workspace)
                if not os.path.exists(os.path.join(workspacepath,"namespace.xml")) or not os.path.exists(os.path.join(workspacepath,"workspace.xml")):
                    #not a valid workspace
                    print("The workspace '{}' is not enabled".format(workspace))
                    continue

                layergroupspath = os.path.join(workspacepath,"layergroups")
                if not os.path.exists(layergroupspath) or not os.path.dir(layergoupspath):
                    continue

                self.layergroups[workspace] = {}
                for layergroupfile in os.listdir(layergroupspath):
                    if not layergroupfile.endswith(".xml"):
                        #not a layergroup xml file
                        continue
                    layergroup = layergroupfile[:-4]
                    layergroupfile = os.path.join(layergroupspath,layergroupfile)

                    with open(layergroupfile) as f:
                        data = f.read()
                    m = layergroupid_re.search(data)
                    if not m:
                        self.errors.append(("{}:{}".format(workspace,wmslayer),"Invalid layergroup '{}:{}', can't find the layergroup id in file '{}'".format(workspace,layergroup,layergroupfile)))
                        continue

                    layergroupid = m.group("id")
                    self.layergroupids[layergroupid] = (workspace,layergroup,layergroupfile)
                    self.layergroups[workspace][layergroup] = (layergroupid,layergroupfile)

                    workspace = workspaceid_re.search(data)
                    if not m:
                        self.errors.append(("{}:{}".format(workspace,,layergroup),"Invalid layergroup '{}:{}', can't find the workspace id in file '{}'".format(workspace,layergroup,layergroupfile)))
                            continue

                    workspaceid = m.group("id")
                    if workspaceid not in self.workspaceids:
                        self.errors.append(("{}:{}".format(workspace,layergroup),"Invalid layergroup '{0}:{1}', the namespace id({3}) in file '{2}' doesn't exist'".format(workspace,layergroup,layergroupfile,workspaceid)))
                        continue

                    start = 0
                    while True:
                        m = layerid_re.search(data,start)
                        if not m:
                            break
                        layerid = m.group("id")
                        if layerid not in self.layerids:
                            self.errors.append(("{}:{}".format(workspace,layergroup),"Invalid layergroup '{0}:{1}', the layer id({3}) in file '{2}' doesn't exist'".format(workspace,layergroup,layergroupfile,layerid)))
                        start = m.end()

                    start = data.find("<publishables>")
                    if start < 0:
                        self.errors.append(("{}:{}}".format(workspace,layergroup),"Invalid layergroup '{0}:{1}', can't find '<pubishables>' in file '{2}'".format(workspace,layergroup,layergroupfile)))
                    else:
                        while True:
                            m = layergroupid_re.search(data,start)
                            if not m:
                                break
                            layergroupid1 = m.group("id")
                            if layergroupid1 == layergroupid:
                                self.errors.append(("{}:{}".format(workspace,layergroup),"Invalid layergroup '{0}:{1}', the layergroup can't add itself as a member layer  in file '{2}'".format(workspace,layergroup,layergroupfile)))
                            elif layergroupid1 not in self.layergroupids:
                                self.errors.append(("{}:{}".format(workspace,layergroup),"Invalid layergroup '{0}:{1}', the member layergroup id({3}) in file '{2}' doesn't exist'".format(workspace,layergroup,layergroupfile,layergroupid1)))
                            start = m.end()

                    start = 0
                    while True:
                        m = styleid_re.search(data,start)
                        if not m:
                            break
                        styleid = m.group("id")
                        if styleid not in self.styleids:
                            self.errors.append(("{}:{}".format(workspace,layergroup),"Invalid featuretype '{0}:{1}', the style id({3}) in file '{2}' doesn't exist'".format(workspace,layergroup,layergroupfile,styleid)))
                        start = m.end()

                        
                if len(self.layergroups[workspace]) > 0:
                    print("Load {1} wmslayers in workspace({0})".format(workspace,len(self.layergroupss[workspace])))

        count = 0
        for workspace,workspaceata in self.layergroups.items():
            count += len(workspacedata)
        if count > 0:
            print("Load {} layergroups".format(count))

    def _load_styles(self):
        #load the default styles 
        for style in os.listdir(os.path.join(self.geoserver_data_dir,"styles")):
            if not style.endswith(".xml"):
                continue
            stylefile = os.path.join(self.geoserver_data_dir,"styles",style)
            with open(stylefile) as f:
                data = f.read()
            m = styleid_re.search(data)
            if not m:
                self.errors.append((stylefile,"Invalid style '{}', can't find the style id".format(stylefile)))
                continue

            styleid = m.group("id")
            self.styleids[styleid] = ("__builtin__",stylefile)
            self.styles["__builtin__"] = (styleid,stylefile)

        print("Load {} builtin styles".format(len(self.styles["__builtin__"])))

        #load styles in workspace
        for workspace in os.listdir(os.path.join(self.geoserver_data_dir,"workspaces")):
            if workspace == "styles":
                #default styles
                for style in os.listdir(os.path.join(self.geoserver_data_dir,"workspaces","styles")):
                    if not style.endswith(".xml"):
                        continue
                    stylefile = os.path.join(self.geoserver_data_dir,"workspaces","styles",style)
                    with open(stylefile) as f:
                        data = f.read()
                    m = styleid_re.search(data)
                    if not m:
                        self.errors.append((stylefile,"Invalid style '{}', can't find the style id".format(stylefile)))
                        continue

                    styleid = m.group("id")
                    self.styleids[styleid] = ("",stylefile)
                    self.styles[""] = (styleid,stylefile)

                print("Load {} styles in empty workspace".format(len(self.styles[""])))

            elif not os.path.isdir(os.path.join(self.geoserver_data_dir,"workspaces",workspace)):
                #not a workspace
                continue
            else:
                workspacepath = os.path.join(self.geoserver_data_dir,"workspaces",workspace)
                if not os.path.exists(os.path.join(workspacepath,"namespace.xml")) or not os.path.exists(os.path.join(workspacepath,"workspace.xml")):
                    #workspace is not enabled
                    print("The workspace '{}' is not enabled".format(workspace))
                    self.warnings.append((workspace,"The workspace '{}' is not enabled".format(workspace)))
                    continue

                if os.path.exists(os.path.join(workspacepath,"styles")) and os.path.isdir(os.path.join(workspacepath,"styles")):
                    for style in os.listdir(os.path.join(workspacepath,"styles")):
                        if not style.endswith(".xml"):
                            continue
                        stylefile = os.path.join(workspacepath,"styles",style)
                        with open(stylefile) as f:
                            data = f.read()
                        m = styleid_re.search(data)
                        if not m:
                            self.errors.append((stylefile,"Invalid style '{}', can't find the style id".format(stylefile)))
                            continue

                        styleid = m.group("id")
                        self.styleids[styleid] = (workspace,stylefile)
                        self.styles[workspace] = (styleid,stylefile)
                    print("Load {1} styles in {0} workspace".format(workspace,len(self.styles[""])))

        print("Load {} styles".format(len(self.styleids)))

    def _load_gwclayers(self):
        gwclayersdir = os.path.join(self.geoserver_data_dir,"gwc-layers")):
        if not os.path.exists(gwclayersdir):
            self.errors.append(("gwc-layers","The gwc layers folder '{}' doesn't exist'".format(gwclayersdir)))
            return

        for gwclayerfile in os.listdir(gwclayersdir):
            if not gwclayerfile.endswith(".xml"):
                continue
            gwclayerfile = os.path.join(gwclayersdir,gwclayerfile)
            with open(gwclayerfile) as f:
                data = f.read()

            m = gwclayername_re.search(data)
            if not m:
                self.errors.append((stylefile,"Invalid gwclayer file '{}', can't find the gwclayer name".format(gwclayerfile)))
                continue
            gwclayername = m.group("name")
            if ":" in  gwclayername:
                workspace,layername = gwclayername.split(":",1)
            else:
                workspace  = ""
                layername = gwclayername

            if workspace not in self.gwclayers:
                self.gwclayers[workspace] = {}

            self.gwclayers[]
            

            m = layerid_re.search(data)
            if not m:
                self.errors.append((stylefile,"Invalid gwclayer file '{}', can't find the layerid".format(gwclayerfile)))
                continue
            if 

            self.styleids[styleid] = ("__builtin__",stylefile)
            self.styles["__builtin__"] = (styleid,stylefile)

        print("Load {} builtin styles".format(len(self.styles["__builtin__"])))

        #load styles in workspace
        for workspace in os.listdir(os.path.join(self.geoserver_data_dir,"workspaces")):
            if workspace == "styles":
                #default styles
                for style in os.listdir(os.path.join(self.geoserver_data_dir,"workspaces","styles")):
                    if not style.endswith(".xml"):
                        continue
                    stylefile = os.path.join(self.geoserver_data_dir,"workspaces","styles",style)
                    with open(stylefile) as f:
                        data = f.read()
                    m = styleid_re.search(data)
                    if not m:
                        self.errors.append((stylefile,"Invalid style '{}', can't find the style id".format(stylefile)))
                        continue

                    styleid = m.group("id")
                    self.styleids[styleid] = ("",stylefile)
                    self.styles[""] = (styleid,stylefile)

                print("Load {} styles in empty workspace".format(len(self.styles[""])))

            elif not os.path.isdir(os.path.join(self.geoserver_data_dir,"workspaces",workspace)):
                #not a workspace
                continue
            else:
                workspacepath = os.path.join(self.geoserver_data_dir,"workspaces",workspace)
                if not os.path.exists(os.path.join(workspacepath,"namespace.xml")) or not os.path.exists(os.path.join(workspacepath,"workspace.xml")):
                    #workspace is not enabled
                    print("The workspace '{}' is not enabled".format(workspace))
                    self.warnings.append((workspace,"The workspace '{}' is not enabled".format(workspace)))
                    continue

                if os.path.exists(os.path.join(workspacepath,"styles")) and os.path.isdir(os.path.join(workspacepath,"styles")):
                    for style in os.listdir(os.path.join(workspacepath,"styles")):
                        if not style.endswith(".xml"):
                            continue
                        stylefile = os.path.join(workspacepath,"styles",style)
                        with open(stylefile) as f:
                            data = f.read()
                        m = styleid_re.search(data)
                        if not m:
                            self.errors.append((stylefile,"Invalid style '{}', can't find the style id".format(stylefile)))
                            continue

                        styleid = m.group("id")
                        self.styleids[styleid] = (workspace,stylefile)
                        self.styles[workspace] = (styleid,stylefile)
                    print("Load {1} styles in {0} workspace".format(workspace,len(self.styles[""])))

        print("Load {} styles".format(len(self.styleids)))

    def check(self):
        self._load_workspaces()
        self._load_styles()
        self._load_datastores()
        self._load_wmsstores()
        self._load_featuretypes()
        self._load_wmslayers()
        self._load_layergroup()


        pass

if __name__ == '__main__':
    geoserver_data_dir = os.environ["GEOSERVER_DATA_DIR"]

    consistencycheck = GeoserverDataConsistencyCheck(geoserver_data_dir)
    consistencycheck.check()

